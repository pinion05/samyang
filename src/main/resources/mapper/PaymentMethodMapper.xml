<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.farm404.samyang.mapper.PaymentMethodMapper">
    
    <!-- 결제수단 조회 -->
    <!-- TODO: [최소수정] resultType 전체 경로 지정 필요 -->
    <select id="selectPaymentMethodById" resultType="com.farm404.samyang.dto.PaymentMethodDTO">
        SELECT 
            pm.PaymentMethodID as paymentMethodId,
            pm.UserID as userId,
            /* TODO: [DB매핑오류] payment_type, card_holder_name, billing_address 컬럼 없음
               실제 DB 컬럼: PaymentMethodID, UserID, CardNumber, ExpiryDate, CVC */
            NULL as paymentType,  -- DB에 없는 컬럼
            pm.CardNumber as cardNumber,
            NULL as cardHolderName,  -- DB에 없는 컬럼  
            pm.ExpiryDate as expiryDate,
            pm.CVC as cvc,
            NULL as billingAddress,  -- DB에 없는 컬럼
            NULL as createdAt,  -- PaymentMethod 테이블에 없음
            NULL as updatedAt,  -- PaymentMethod 테이블에 없음
            u.Name AS userName
        FROM PaymentMethod pm
        LEFT JOIN User u ON pm.UserID = u.UserID
        WHERE pm.PaymentMethodID = #{paymentMethodId}
    </select>
    
    <!-- 사용자별 결제수단 목록 조회 -->
    <select id="selectPaymentMethodsByUserId" resultType="com.farm404.samyang.dto.PaymentMethodDTO">
        SELECT 
            pm.payment_method_id,
            pm.user_id,
            pm.payment_type,
            pm.card_number,
            pm.card_holder_name,
            pm.expiry_date,
            pm.CVC as cvc,
            pm.billing_address,
            pm.created_at,
            pm.updated_at,
            u.name AS userName
        FROM payment_method pm
        LEFT JOIN user u ON pm.user_id = u.user_id
        WHERE pm.user_id = #{userId}
        ORDER BY pm.created_at DESC
    </select>
    
    <!-- 모든 결제수단 조회 (관리자용) -->
    <select id="selectAllPaymentMethods" resultType="com.farm404.samyang.dto.PaymentMethodDTO">
        SELECT 
            pm.payment_method_id,
            pm.user_id,
            pm.payment_type,
            pm.card_number,
            pm.card_holder_name,
            pm.expiry_date,
            pm.CVC as cvc,
            pm.billing_address,
            pm.created_at,
            pm.updated_at,
            u.name AS userName
        FROM payment_method pm
        LEFT JOIN user u ON pm.user_id = u.user_id
        ORDER BY pm.created_at DESC
    </select>
    
    <!-- 결제수단 타입별 조회 -->
    <select id="selectPaymentMethodsByType" resultType="com.farm404.samyang.dto.PaymentMethodDTO">
        SELECT 
            pm.payment_method_id,
            pm.user_id,
            pm.payment_type,
            pm.card_number,
            pm.card_holder_name,
            pm.expiry_date,
            pm.CVC as cvc,
            pm.billing_address,
            pm.created_at,
            pm.updated_at,
            u.name AS userName
        FROM payment_method pm
        LEFT JOIN user u ON pm.user_id = u.user_id
        WHERE pm.user_id = #{userId}
        <if test="paymentType != null and paymentType != ''">
            AND pm.payment_type = #{paymentType}
        </if>
        ORDER BY pm.created_at DESC
    </select>
    
    <!-- 결제수단 등록 -->
    <!-- TODO: [최소수정] parameterType 전체 경로 지정 필요 -->
    <insert id="insertPaymentMethod" parameterType="com.farm404.samyang.dto.PaymentMethodDTO">
        INSERT INTO PaymentMethod (
            UserID,
            CardNumber,
            ExpiryDate,
            CVC
            /* TODO: [DB매핑오류] payment_type, card_holder_name, billing_address 컬럼 없음
               created_at, updated_at도 PaymentMethod 테이블에 없음 */
        ) VALUES (
            #{userId},
            #{cardNumber},
            #{expiryDate},
            #{cvc}
        )
    </insert>
    
    <!-- 결제수단 수정 -->
    <update id="updatePaymentMethod" parameterType="PaymentMethodDTO">
        UPDATE PaymentMethod
        SET 
            CardNumber = #{cardNumber},
            ExpiryDate = #{expiryDate},
            CVC = #{cvc}
        WHERE PaymentMethodID = #{paymentMethodId}
    </update>
    
    <!-- 결제수단 삭제 -->
    <delete id="deletePaymentMethod">
        DELETE FROM PaymentMethod
        WHERE PaymentMethodID = #{paymentMethodId}
    </delete>
    
    <!-- 사용자의 기본 결제수단 조회 (가장 최근에 등록된 것) -->
    <select id="selectDefaultPaymentMethod" resultType="com.farm404.samyang.dto.PaymentMethodDTO">
        SELECT 
            pm.payment_method_id,
            pm.user_id,
            pm.payment_type,
            pm.card_number,
            pm.card_holder_name,
            pm.expiry_date,
            pm.CVC as cvc,
            pm.billing_address,
            pm.created_at,
            pm.updated_at,
            u.name AS userName
        FROM payment_method pm
        LEFT JOIN user u ON pm.user_id = u.user_id
        WHERE pm.user_id = #{userId}
        ORDER BY pm.created_at DESC
        LIMIT 1
    </select>
    
    <!-- 카드번호 중복 체크 -->
    <select id="checkCardNumberExists" resultType="int">
        SELECT COUNT(*)
        FROM PaymentMethod
        WHERE CardNumber = #{cardNumber}
        <if test="excludeId != null">
            AND PaymentMethodID != #{excludeId}
        </if>
    </select>
    
</mapper>