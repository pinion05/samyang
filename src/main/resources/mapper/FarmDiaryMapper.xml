<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
				"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.farm404.samyang.mapper.FarmDiaryMapper">

	<!-- 결과 매핑 정의 -->
	<resultMap id="FarmDiaryResultMap" type="com.farm404.samyang.dto.FarmDiaryDTO">
		<id property="농사일지ID" column="농사일지ID" />
		<result property="사용자ID" column="사용자ID" />
		<result property="작물ID" column="작물ID" />
		<result property="날짜" column="날짜" />
		<result property="활동_유형" column="활동_유형" />
		<result property="내용" column="내용" />
		<result property="사진_URL" column="사진_URL" />
		<result property="작성일시" column="작성일시" />
		<result property="사용자이름" column="사용자이름" />
		<result property="작물명" column="작물명" />
	</resultMap>

	<!-- 농사일지 등록 -->
	<insert id="insertFarmDiary" parameterType="com.farm404.samyang.dto.FarmDiaryDTO" useGeneratedKeys="true" keyProperty="농사일지ID">
		INSERT INTO 농사일지 (
			사용자ID, 작물ID, 날짜, 활동_유형, 내용, 사진_URL
		) VALUES (
			#{사용자ID}, #{작물ID}, #{날짜}, #{활동_유형}, #{내용}, #{사진_URL}
		)
	</insert>

	<!-- 농사일지 목록 조회 (사용자, 작물 정보 포함) -->
	<select id="selectFarmDiaryList" parameterType="com.farm404.samyang.dto.FarmDiaryDTO" resultMap="FarmDiaryResultMap">
		SELECT 
			fd.농사일지ID, fd.사용자ID, fd.작물ID, fd.날짜, fd.활동_유형, fd.내용, fd.사진_URL, fd.작성일시,
			u.이름 as 사용자이름,
			c.작물명 as 작물명
		FROM 농사일지 fd
		LEFT JOIN 사용자 u ON fd.사용자ID = u.사용자ID
		LEFT JOIN 작물 c ON fd.작물ID = c.작물ID
		<where>
			<if test="검색키워드 != null and 검색키워드 != ''">
				AND (fd.활동_유형 LIKE CONCAT('%', #{검색키워드}, '%') 
				 OR fd.내용 LIKE CONCAT('%', #{검색키워드}, '%')
				 OR u.이름 LIKE CONCAT('%', #{검색키워드}, '%')
				 OR c.작물명 LIKE CONCAT('%', #{검색키워드}, '%'))
			</if>
			<if test="활동필터 != null and 활동필터 != ''">
				AND fd.활동_유형 = #{활동필터}
			</if>
			<if test="사용자ID != null">
				AND fd.사용자ID = #{사용자ID}
			</if>
			<if test="작물ID != null">
				AND fd.작물ID = #{작물ID}
			</if>
			<if test="시작날짜 != null">
				AND fd.날짜 >= #{시작날짜}
			</if>
			<if test="종료날짜 != null">
				AND fd.날짜 <= #{종료날짜}
			</if>
		</where>
		ORDER BY fd.날짜 DESC, fd.작성일시 DESC
	</select>

	<!-- 농사일지 상세 조회 -->
	<select id="selectFarmDiaryById" parameterType="int" resultMap="FarmDiaryResultMap">
		SELECT 
			fd.농사일지ID, fd.사용자ID, fd.작물ID, fd.날짜, fd.활동_유형, fd.내용, fd.사진_URL, fd.작성일시,
			u.이름 as 사용자이름,
			c.작물명 as 작물명
		FROM 농사일지 fd
		LEFT JOIN 사용자 u ON fd.사용자ID = u.사용자ID
		LEFT JOIN 작물 c ON fd.작물ID = c.작물ID
		WHERE fd.농사일지ID = #{농사일지ID}
	</select>

	<!-- 사용자별 농사일지 목록 조회 -->
	<select id="selectFarmDiaryListByUserId" parameterType="int" resultMap="FarmDiaryResultMap">
		SELECT 
			fd.농사일지ID, fd.사용자ID, fd.작물ID, fd.날짜, fd.활동_유형, fd.내용, fd.사진_URL, fd.작성일시,
			u.이름 as 사용자이름,
			c.작물명 as 작물명
		FROM 농사일지 fd
		LEFT JOIN 사용자 u ON fd.사용자ID = u.사용자ID
		LEFT JOIN 작물 c ON fd.작물ID = c.작물ID
		WHERE fd.사용자ID = #{사용자ID}
		ORDER BY fd.날짜 DESC, fd.작성일시 DESC
	</select>

	<!-- 작물별 농사일지 목록 조회 -->
	<select id="selectFarmDiaryListByCropId" parameterType="int" resultMap="FarmDiaryResultMap">
		SELECT 
			fd.농사일지ID, fd.사용자ID, fd.작물ID, fd.날짜, fd.활동_유형, fd.내용, fd.사진_URL, fd.작성일시,
			u.이름 as 사용자이름,
			c.작물명 as 작물명
		FROM 농사일지 fd
		LEFT JOIN 사용자 u ON fd.사용자ID = u.사용자ID
		LEFT JOIN 작물 c ON fd.작물ID = c.작물ID
		WHERE fd.작물ID = #{작물ID}
		ORDER BY fd.날짜 DESC, fd.작성일시 DESC
	</select>

	<!-- 농사일지 정보 수정 -->
	<update id="updateFarmDiary" parameterType="com.farm404.samyang.dto.FarmDiaryDTO">
		UPDATE 농사일지 SET
			작물ID = #{작물ID},
			날짜 = #{날짜},
			활동_유형 = #{활동_유형},
			내용 = #{내용},
			사진_URL = #{사진_URL}
		WHERE 농사일지ID = #{농사일지ID}
	</update>

	<!-- 농사일지 삭제 -->
	<delete id="deleteFarmDiary" parameterType="int">
		DELETE FROM 농사일지
		WHERE 농사일지ID = #{농사일지ID}
	</delete>

	<!-- 농사일지 수 조회 -->
	<select id="selectFarmDiaryCount" parameterType="com.farm404.samyang.dto.FarmDiaryDTO" resultType="int">
		SELECT COUNT(*) 
		FROM 농사일지 fd
		LEFT JOIN 사용자 u ON fd.사용자ID = u.사용자ID
		LEFT JOIN 작물 c ON fd.작물ID = c.작물ID
		<where>
			<if test="검색키워드 != null and 검색키워드 != ''">
				AND (fd.활동_유형 LIKE CONCAT('%', #{검색키워드}, '%') 
				 OR fd.내용 LIKE CONCAT('%', #{검색키워드}, '%')
				 OR u.이름 LIKE CONCAT('%', #{검색키워드}, '%')
				 OR c.작물명 LIKE CONCAT('%', #{검색키워드}, '%'))
			</if>
			<if test="활동필터 != null and 활동필터 != ''">
				AND fd.활동_유형 = #{활동필터}
			</if>
			<if test="사용자ID != null">
				AND fd.사용자ID = #{사용자ID}
			</if>
			<if test="작물ID != null">
				AND fd.작물ID = #{작물ID}
			</if>
			<if test="시작날짜 != null">
				AND fd.날짜 >= #{시작날짜}
			</if>
			<if test="종료날짜 != null">
				AND fd.날짜 <= #{종료날짜}
			</if>
		</where>
	</select>

	<!-- 사용자별 농사일지 수 조회 -->
	<select id="selectFarmDiaryCountByUserId" parameterType="int" resultType="int">
		SELECT COUNT(*) 
		FROM 농사일지
		WHERE 사용자ID = #{사용자ID}
	</select>

	<!-- 작물별 농사일지 수 조회 -->
	<select id="selectFarmDiaryCountByCropId" parameterType="int" resultType="int">
		SELECT COUNT(*) 
		FROM 농사일지
		WHERE 작물ID = #{작물ID}
	</select>

</mapper>