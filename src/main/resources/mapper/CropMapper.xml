<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
				"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.farm404.samyang.mapper.CropMapper">

	<!-- 결과 매핑 정의 -->
	<resultMap id="CropResultMap" type="com.farm404.samyang.dto.CropDTO">
		<id property="cropId" column="crop_id" />
		<result property="userId" column="user_id" />
		<result property="cropName" column="crop_name" />
		<result property="variety" column="variety" />
		<result property="plantingDate" column="planting_date" />
		<result property="expectedHarvestDate" column="expected_harvest_date" />
		<result property="status" column="status" />
		<result property="userName" column="user_name" />
	</resultMap>

	<!-- 작물 등록 -->
	<insert id="insertCrop" parameterType="com.farm404.samyang.dto.CropDTO" useGeneratedKeys="true" keyProperty="cropId">
		INSERT INTO Crop (
			user_id, crop_name, variety, planting_date, expected_harvest_date, status
		) VALUES (
			#{userId}, #{cropName}, #{variety}, #{plantingDate}, #{expectedHarvestDate}, #{status}
		)
	</insert>

	<!-- 작물 목록 조회 (사용자 정보 포함) -->
	<select id="selectCropList" parameterType="com.farm404.samyang.dto.CropDTO" resultMap="CropResultMap">
		SELECT 
			c.crop_id, c.user_id, c.crop_name, c.variety, c.planting_date, c.expected_harvest_date, c.status,
			u.name as user_name
		FROM Crop c
		LEFT JOIN User u ON c.user_id = u.user_id
		<where>
			<if test="searchKeyword != null and searchKeyword != ''">
				AND (c.crop_name LIKE CONCAT('%', #{searchKeyword}, '%') 
				 OR c.variety LIKE CONCAT('%', #{searchKeyword}, '%')
				 OR u.name LIKE CONCAT('%', #{searchKeyword}, '%'))
			</if>
			<if test="statusFilter != null and statusFilter != ''">
				AND c.status = #{statusFilter}
			</if>
			<if test="userId != null">
				AND c.user_id = #{userId}
			</if>
		</where>
		ORDER BY c.planting_date DESC
	</select>

	<!-- 작물 상세 조회 -->
	<select id="selectCropById" parameterType="int" resultMap="CropResultMap">
		SELECT 
			c.crop_id, c.user_id, c.crop_name, c.variety, c.planting_date, c.expected_harvest_date, c.status,
			u.name as user_name
		FROM Crop c
		LEFT JOIN User u ON c.user_id = u.user_id
		WHERE c.crop_id = #{cropId}
	</select>

	<!-- 사용자별 작물 목록 조회 -->
	<select id="selectCropListByUserId" parameterType="int" resultMap="CropResultMap">
		SELECT 
			c.crop_id, c.user_id, c.crop_name, c.variety, c.planting_date, c.expected_harvest_date, c.status,
			u.name as user_name
		FROM Crop c
		LEFT JOIN User u ON c.user_id = u.user_id
		WHERE c.user_id = #{userId}
		ORDER BY c.planting_date DESC
	</select>

	<!-- 작물 정보 수정 -->
	<update id="updateCrop" parameterType="com.farm404.samyang.dto.CropDTO">
		UPDATE Crop SET
			crop_name = #{cropName},
			variety = #{variety},
			planting_date = #{plantingDate},
			expected_harvest_date = #{expectedHarvestDate},
			status = #{status}
		WHERE crop_id = #{cropId}
	</update>

	<!-- 작물 삭제 -->
	<delete id="deleteCrop" parameterType="int">
		DELETE FROM Crop
		WHERE crop_id = #{cropId}
	</delete>

	<!-- 작물 수 조회 -->
	<select id="selectCropCount" parameterType="com.farm404.samyang.dto.CropDTO" resultType="int">
		SELECT COUNT(*) 
		FROM Crop c
		LEFT JOIN User u ON c.user_id = u.user_id
		<where>
			<if test="searchKeyword != null and searchKeyword != ''">
				AND (c.crop_name LIKE CONCAT('%', #{searchKeyword}, '%') 
				 OR c.variety LIKE CONCAT('%', #{searchKeyword}, '%')
				 OR u.name LIKE CONCAT('%', #{searchKeyword}, '%'))
			</if>
			<if test="statusFilter != null and statusFilter != ''">
				AND c.status = #{statusFilter}
			</if>
			<if test="userId != null">
				AND c.user_id = #{userId}
			</if>
		</where>
	</select>

	<!-- 사용자별 작물 수 조회 -->
	<select id="selectCropCountByUserId" parameterType="int" resultType="int">
		SELECT COUNT(*) 
		FROM Crop
		WHERE user_id = #{userId}
	</select>

</mapper>