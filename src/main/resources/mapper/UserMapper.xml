<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
				"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.farm404.samyang.mapper.UserMapper">

	<!-- 결과 매핑 정의 -->
	<resultMap id="UserResultMap" type="com.farm404.samyang.dto.UserDTO">
		<id property="userId" column="user_id" />
		<result property="name" column="name" />
		<result property="email" column="email" />
		<result property="password" column="password" />
		<result property="phone" column="phone" />
		<result property="address" column="address" />
		<result property="isAdmin" column="is_admin" />
		<result property="createdAt" column="created_at" />
	</resultMap>

	<!-- 사용자 등록 -->
	<insert id="insertUser" parameterType="com.farm404.samyang.dto.UserDTO" useGeneratedKeys="true" keyProperty="userId">
		INSERT INTO User (
			name, email, password, phone, address, is_admin
		) VALUES (
			#{name}, #{email}, #{password}, #{phone}, #{address}, #{isAdmin}
		)
	</insert>

	<!-- 사용자 목록 조회 -->
	<select id="selectUserList" parameterType="com.farm404.samyang.dto.UserDTO" resultMap="UserResultMap">
		SELECT 
			user_id, name, email, phone, address, is_admin, created_at
		FROM User
		<where>
			<if test="searchKeyword != null and searchKeyword != ''">
				AND (name LIKE CONCAT('%', #{searchKeyword}, '%') 
				 OR email LIKE CONCAT('%', #{searchKeyword}, '%'))
			</if>
		</where>
		ORDER BY created_at DESC
	</select>

	<!-- 사용자 상세 조회 -->
	<select id="selectUserById" parameterType="int" resultMap="UserResultMap">
		SELECT 
			user_id, name, email, phone, address, is_admin, created_at
		FROM User
		WHERE user_id = #{userId}
	</select>

	<!-- 이메일로 사용자 조회 (로그인용) -->
	<select id="selectUserByEmail" parameterType="string" resultMap="UserResultMap">
		SELECT 
			user_id, name, email, password, phone, address, is_admin, created_at
		FROM User
		WHERE email = #{email}
	</select>

	<!-- 사용자 정보 수정 -->
	<update id="updateUser" parameterType="com.farm404.samyang.dto.UserDTO">
		UPDATE User SET
			name = #{name},
			phone = #{phone},
			address = #{address}
			<if test="password != null and password != ''">
				, password = #{password}
			</if>
		WHERE user_id = #{userId}
	</update>

	<!-- 사용자 삭제 -->
	<delete id="deleteUser" parameterType="int">
		DELETE FROM User
		WHERE user_id = #{userId}
	</delete>

	<!-- 로그인 검증 (기존 메서드 호환) -->
	<select id="getLogin" resultType="int">
		SELECT COUNT(*) 
		FROM User
		WHERE email = #{email} AND password = #{password}
	</select>

	<!-- 이메일 중복 체크 -->
	<select id="checkEmailExists" parameterType="string" resultType="int">
		SELECT COUNT(*) 
		FROM User
		WHERE email = #{email}
	</select>

	<!-- 전체 사용자 수 조회 -->
	<select id="selectUserCount" parameterType="com.farm404.samyang.dto.UserDTO" resultType="int">
		SELECT COUNT(*) 
		FROM User
		<where>
			<if test="searchKeyword != null and searchKeyword != ''">
				AND (name LIKE CONCAT('%', #{searchKeyword}, '%') 
				 OR email LIKE CONCAT('%', #{searchKeyword}, '%'))
			</if>
		</where>
	</select>

</mapper>